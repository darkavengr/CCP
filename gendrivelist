#!/bin/bash
#
# generate driver init function
#
echo // Auto-generated file- do not edit!>drive.c
echo \#define NULL 0 >>drive.c
echo \#include \"string.h\">>drive.c
echo \#include \"vfs.h\">>drive.c
echo \#include \"module.h\">>drive.c
echo>>drive.c

echo extern size_t AddModule\(KERNELMODULE *entry\)\;>>drive.c
echo void driver_init\(void\) {>>drive.c
echo KERNELMODULE kernelmodule\;>>drive.c

export arch=$1
shift
for f in $*; do
	dirname=`echo $f | rev | cut -d/ -f 2 | rev`
	name=`echo $f | rev | cut -d/ -f 1 | rev`

	if [ $dirname == "drivers" ]  || [ $dirname == "filesystems" ] || [ $dirname == "binfmt" ]; then
		initname=`grep "#define MODULE_INIT" $f/$name.c | cut -f3 -d " "`	# extract name from module source

		# Check if there is no init module name

		test -z $initname
		if [ $? == 0 ]; then
			echo "gendrivelist: Can't find module intialisation function for " $f/$name.c
			exit 1
		fi

		echo Including driver $name
		echo extern $initname\(\)\;>>drive.c

		echo strncpy\(kernelmodule.filename,\"$name.o\",MAX_PATH\)\;>>drive.c
		echo kernelmodule.startaddress=\&$initname\;>>drive.c

		#             Extract symbols	            | Get function| Remove top | Convert multiple | Extract symbol  | Convert  | Convert +
		#				            | symbols     |	       | spaces to spaces | sizes           |	newlines | to + with
		#															to +	 | space									
		export add=$(readelf -s ~/programs/ccp/obj/i386/keyb.o | grep "FUNC" | sed 's/ \+ / /g' | cut -d ' ' -f 4 | tr \\n + | sed s/+/" + "/g)
		export add=`echo $add | sed s/.$//`		# remove trailing +

		echo kernelmodule.size=`expr $add`\;>>drive.c
		echo AddModule\(\&kernelmodule\)\;>>drive.c
		echo $initname\(NULL\)\;>>drive.c
	fi

done

echo }>>drive.c

